<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Farming Game Deluxe</title>
<style>
:root{
  --accent:#00ff7f;
  --bg1:#0f1112;
  --bg2:#121212;
  --card:#161616;
  --muted:#bfc9bd;
  --glass: rgba(255,255,255,0.03);
  --radius:14px;
  --coin-color: #ffd700;
}
*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0;
  font-family: 'Trebuchet MS', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  background: url('BALTI.JPG') center/cover no-repeat, radial-gradient(circle at 20% 10%, #16201a 0%, #080808 60%);
  color:#e9fff0;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:28px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.container{
  width:980px;
  max-width:95vw;
  display:grid;
  grid-template-columns: 1fr 320px;
  gap:22px;
  align-items:start;
}
header{grid-column:1/-1; text-align:center}
h1{
  margin:0 0 10px 0;
  font-size:1.9rem;
  color:var(--accent);
  text-shadow:0 0 12px rgba(0,255,127,0.12);
}
.sub{color:var(--muted); margin-bottom:12px}
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  padding:14px;
  border-radius:var(--radius);
  border:1px solid rgba(0,255,127,0.08);
  box-shadow:0 6px 30px rgba(0,0,0,0.6), inset 0 0 30px rgba(0,255,127,0.02);
}
#canvasWrap{display:flex;flex-direction:column;gap:10px;align-items:center}
canvas{width:560px; height:560px; border-radius:12px; background:linear-gradient(180deg,#1b1b1b,#0d0d0d); box-shadow:0 0 30px rgba(0,255,127,0.06); display:block; image-rendering: pixelated;}
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.btn{cursor:pointer; border:none; padding:10px 16px; border-radius:12px; background:linear-gradient(#00ff7f,#008a4a); color:#002; font-weight:700; box-shadow:0 6px 20px rgba(0,255,127,0.08); transition:transform .12s}
.btn:active{transform:translateY(2px)}
.btn:disabled{opacity:0.5; cursor:not-allowed; background:gray;}
#infoRow{display:flex; gap:10px; width:100%; margin-top:6px; align-items:center}
.statBox{flex:1; padding:10px; background:var(--card); border-radius:10px; text-align:left}
.statTitle{font-size:0.85rem; color:var(--muted)}
.statValue{font-weight:700; font-size:1.05rem}
#side{display:flex; flex-direction:column; gap:14px}
#stats{min-height:160px}
#strainLog{max-height:220px; overflow:auto; font-size:0.92rem; color:var(--muted); padding:8px; background:var(--glass); border-radius:10px}
#breederCard{display:flex; flex-direction:column; align-items:center; gap:10px; padding:12px}
#breederCard img{width:100%; border-radius:10px; display:block}
#breederCard p{margin:0; font-weight:700; color:var(--muted)}
.xpBar{height:12px; background:rgba(255,255,255,0.04); border-radius:999px; overflow:hidden}
.xpFill{height:100%; width:0%; background:linear-gradient(90deg,var(--accent), #8affb8); transition:width 300ms ease}
.toast{position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:#09110a; padding:10px 16px; border-radius:999px; border:1px solid rgba(0,255,127,0.08); box-shadow:0 8px 30px rgba(0,0,0,0.6); display:none}
.backLink{display:inline-block; margin-top:12px; color:var(--muted); text-decoration:none}
#shopPanel .shopItem{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:8px; background:var(--card); border-radius:10px;}
#shopPanel .shopItem button{padding:6px 12px; font-size:0.9rem;}
#achievements ul{list-style:none; padding:0; color:var(--muted);}
#achievements li{margin-bottom:6px; display:flex; align-items:center; gap:6px;}
#achievements li.unlocked{color:var(--accent);}
@media (max-width:900px){
  .container{grid-template-columns:1fr;}
  canvas{width:100%; height:60vh}
}
#confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
</style>
</head>
<body>
<div class="container">
<header>
  <h1>üåø Epic Mini Farming Empire</h1>
  <div class="sub">Unleash seeds, watch them thrive, and harvest epic rewards for ultimate glory!</div>
</header>

<main class="panel" id="canvasWrap">
  <canvas id="farmCanvas" width="560" height="560" aria-label="Farm canvas"></canvas>
  <div class="controls">
    <button class="btn" id="plantBtn">üå± Unleash Random Seed</button>
    <button class="btn" id="harvestBtn">üåæ Harvest Mature Beasts</button>
    <button class="btn" id="fillBtn">üîÅ Dominate Empty Plots</button>
    <div style="flex:1"></div>
    <button class="btn" id="newStartBtn">üöÄ New Empire Start</button>
    <a class="backLink" href="seite3.html">‚óÄ Back to Home Base</a>
  </div>
  <div id="infoRow">
    <div class="statBox">
      <div class="statTitle">Level</div>
      <div class="statValue" id="level">1</div>
    </div>
    <div class="statBox">
      <div class="statTitle">XP</div>
      <div class="statValue" id="xp">0</div>
      <div class="xpBar" style="margin-top:8px"><div id="xpFill" class="xpFill"></div></div>
    </div>
    <div class="statBox">
      <div class="statTitle">Harvested</div>
      <div class="statValue" id="harvested">0</div>
    </div>
    <div class="statBox">
      <div class="statTitle">Coins</div>
      <div class="statValue" id="coins">0</div>
    </div>
  </div>
</main>

<aside class="panel" id="side">
  <div id="stats">
    <strong>üìù Legendary Strain Chronicles</strong>
    <div id="strainLog"></div>
  </div>

  <div id="shopPanel" class="panel">
    <strong>üè™ Ultimate Reward Vault</strong>
    <div id="shopItems"></div>
  </div>

  <div id="achievements" class="panel">
    <strong>üèÜ Epic Achievements</strong>
    <ul id="achievementList"></ul>
  </div>

  <div class="panel">
    <strong>Master the Realm</strong>
    <ul style="padding-left:18px; margin:8px 0 0 0; color:var(--muted)">
      <li>Click a plot to deploy a mighty seed.</li>
      <li>Use "Unleash Random Seed" for chaotic placement.</li>
      <li>Crops evolve over time. Harvest when they glow golden.</li>
      <li>Reap coins and dominate upgrades in the Vault!</li>
    </ul>
  </div>
</aside>
</div>

<div class="toast" id="toast"></div>

<canvas id="confettiCanvas"></canvas>

<audio id="plantSound" src="plant.mp3" preload="auto"></audio>
<audio id="harvestSound" src="harvest.mp3" preload="auto"></audio>
<audio id="levelUpSound" src="levelup.mp3" preload="auto"></audio> <!-- Add a levelup.mp3 if available -->

<script>
// -------------------
// Config & State
// -------------------
const GRID_SIZE = 5;
let strains = [
  {name: "Sticky Buns", color: "#8EE28E", growRate: 6, xp: 12, coins: 5, unlocked: true},
  {name: "Pink Berry Pop", color: "#E6F39B", growRate: 8, xp: 9, coins: 4, unlocked: true},
  {name: "Boom Boom Berry", color: "#6FD08A", growRate: 4.5, xp: 15, coins: 7, unlocked: true},
  {name: "White Rhino", color: "#DFF7D6", growRate: 7, xp: 10, coins: 5, unlocked: true},
  {name: "Golden Kush", color: "#FFD700", growRate: 5, xp: 20, coins: 10, unlocked: false, unlockLevel: 3},
  {name: "Purple Haze", color: "#A020F0", growRate: 9, xp: 8, coins: 6, unlocked: false, unlockLevel: 5}
];
const upgrades = [
  {id: "growthBoost", name: "Growth Accelerator", desc: "+20% Epic Grow Speed", cost: 30, level: 0, maxLevel: 3, effect: () => growthMultiplier += 0.2},
  {id: "xpBoost", name: "XP Surge", desc: "+10% XP Explosion per Harvest", cost: 50, level: 0, maxLevel: 3, effect: () => xpMultiplier += 0.1},
  {id: "coinBoost", name: "Coin Storm", desc: "+15% Coin Rain per Harvest", cost: 40, level: 0, maxLevel: 3, effect: () => coinMultiplier += 0.15},
  {id: "autoPlant", name: "Auto-Deployer", desc: "Automatically conquers empty plots (slowly)", cost: 80, level: 0, maxLevel: 1, effect: () => autoPlantUnlocked = true}
];
const achievements = [
  {id: "firstHarvest", name: "First Conquest", desc: "Harvest your inaugural beast", unlocked: false, condition: () => harvested >= 1},
  {id: "level5", name: "Level 5 Dominance", desc: "Ascend to Level 5", unlocked: false, condition: () => level >= 5},
  {id: "harvest100", name: "100 Harvests of Fury", desc: "Reap 100 mighty plants", unlocked: false, condition: () => harvested >= 100},
  {id: "allUpgrades", name: "Upgrade Overlord", desc: "Max out all upgrades", unlocked: false, condition: () => upgrades.every(u => u.level >= u.maxLevel)}
];
const canvas = document.getElementById('farmCanvas');
const ctx = canvas.getContext('2d');
const farm = Array.from({length: GRID_SIZE}, () => Array(GRID_SIZE).fill(null));
let xp = 0, level = 1, harvested = 0, coins = 100; // Start with 100 coins for testing
let growthMultiplier = 1, xpMultiplier = 1, coinMultiplier = 1, autoPlantUnlocked = false;
let lastAutoPlant = 0;
const backgrounds = ['BALTI.JPG', 'BALTI1.JPG', 'BALTI2.JPG', 'BALTI3.JPG', 'BALTI4.JPG'];

// -------------------
// Classes
// -------------------
class Plant {
  constructor(strain) {
    this.strain = strain;
    this.growth = 0;
    this.particles = [];
    this.sway = Math.random() * Math.PI * 2;
  }
  grow(dt) {
    if (this.growth < 100) {
      this.growth = Math.min(100, this.growth + this.strain.growRate * growthMultiplier * (dt / 1000));
    } else if (Math.random() < 0.06) {
      this.particles.push(new Spark());
    }
    this.particles.forEach(p => p.update(dt));
    this.particles = this.particles.filter(p => !p.dead);
  }
  isReady() { return this.growth >= 100; }
}
class Spark {
  constructor() {
    this.x = 0; this.y = 0; this.vx = (Math.random() - 0.5) * 0.6; this.vy = -Math.random() * 0.8 - 0.2;
    this.life = 700 + Math.random() * 700; this.age = 0; this.size = 1 + Math.random() * 2; this.dead = false;
  }
  update(dt) {
    this.age += dt;
    if (this.age > this.life) this.dead = true;
    this.vy += 0.001 * dt;
    this.x += this.vx * dt * 0.06;
    this.y += this.vy * dt * 0.06;
  }
  draw(ctx) {
    ctx.globalAlpha = 1 - (this.age / this.life);
    ctx.fillStyle = 'rgba(255,255,200,0.9)';
    ctx.fillRect(this.x, this.y, this.size, this.size);
    ctx.globalAlpha = 1;
  }
}

// Confetti Class
class Confetti {
  constructor() {
    this.x = Math.random() * window.innerWidth;
    this.y = -Math.random() * 100;
    this.size = Math.random() * 10 + 5;
    this.color = `hsl(${Math.random() * 360}, 100%, 50%)`;
    this.speed = Math.random() * 5 + 2;
    this.rotation = Math.random() * 360;
    this.rotationSpeed = Math.random() * 10 - 5;
  }
  update() {
    this.y += this.speed;
    this.rotation += this.rotationSpeed;
    if (this.y > window.innerHeight + this.size) {
      this.y = -this.size;
      this.x = Math.random() * window.innerWidth;
    }
  }
  draw(ctx) {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation * Math.PI / 180);
    ctx.fillStyle = this.color;
    ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
    ctx.restore();
  }
}

// -------------------
// Helpers
// -------------------
function shadeColor(hex, percent) {
  const num = parseInt(hex.slice(1), 16);
  const r = Math.max(0, Math.min(255, (num >> 16) + Math.round(255 * percent / 100)));
  const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + Math.round(255 * percent / 100)));
  const b = Math.max(0, Math.min(255, (num & 0x0000FF) + Math.round(255 * percent / 100)));
  return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}
function addLog(text) {
  const time = new Date().toLocaleTimeString();
  document.getElementById('strainLog').innerHTML = `<div style="margin-bottom:6px"><small style='color:var(--muted)'>[${time}]</small> ${text}</div>` + document.getElementById('strainLog').innerHTML;
}
function updateStats() {
  document.getElementById('xp').textContent = xp;
  document.getElementById('level').textContent = level;
  document.getElementById('harvested').textContent = harvested;
  document.getElementById('coins').textContent = coins;
  const pct = Math.min(100, Math.round((xp / xpThresholdForLevel(level)) * 100));
  document.getElementById('xpFill').style.width = pct + '%';
  renderShop(); // Update shop after stats
}
function xpThresholdForLevel(l) { return 40 + l * 20; }
function showToast(msg, ms = 1500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.style.display = 'none' }, ms);
}
function playSound(id) {
  const a = document.getElementById(id);
  if (a) { a.currentTime = 0; a.play().catch(() => {}); }
}
function saveGame() {
  const saveData = { xp, level, harvested, coins, upgrades: upgrades.map(u => ({level: u.level, cost: u.cost})), achievements: achievements.map(a => a.unlocked), farm: farm.map(row => row.map(p => p ? {strain: strains.findIndex(s => s.name === p.strain.name), growth: p.growth} : null)) };
  localStorage.setItem('miniFarmingSave', JSON.stringify(saveData));
}
function loadGame() {
  const save = localStorage.getItem('miniFarmingSave');
  if (save) {
    const data = JSON.parse(save);
    xp = data.xp; level = data.level; harvested = data.harvested; coins = data.coins;
    upgrades.forEach((u, i) => { u.level = data.upgrades[i].level; u.cost = data.upgrades[i].cost; });
    achievements.forEach((a, i) => a.unlocked = data.achievements[i]);
    farm.forEach((row, r) => row.forEach((_, c) => { const p = data.farm[r][c]; farm[r][c] = p ? new Plant(strains[p.strain]) : null; if (p) farm[r][c].growth = p.growth; }));
    applyUpgrades();
    unlockStrains();
    updateBackground();
  } else {
    coins = 100; // Fallback for new game
  }
  updateStats();
  renderShop();
  renderAchievements();
}
function applyUpgrades() {
  growthMultiplier = 1; xpMultiplier = 1; coinMultiplier = 1; autoPlantUnlocked = false;
  upgrades.forEach(u => { for (let i = 0; i < u.level; i++) u.effect(); });
}
function unlockStrains() {
  strains.forEach(s => { if (s.unlockLevel && level >= s.unlockLevel) s.unlocked = true; });
}
function checkAchievements() {
  let newUnlock = false;
  achievements.forEach(a => {
    if (!a.unlocked && a.condition()) {
      a.unlocked = true;
      newUnlock = true;
      addLog(`üèÜ Epic Achievement Unlocked: ${a.name}`);
      showToast(`Epic Win: ${a.name}!`, 2000);
      coins += 20;
      rainConfetti();
    }
  });
  if (newUnlock) renderAchievements();
}
function renderShop() {
  const shopItems = document.getElementById('shopItems');
  shopItems.innerHTML = '';
  upgrades.forEach(u => {
    const item = document.createElement('div');
    item.className = 'shopItem';
    item.innerHTML = `<div>${u.name} (Lvl ${u.level}/${u.maxLevel})<br><small>${u.desc} - Costs ${u.cost} Coins</small></div>`;
    const buyBtn = document.createElement('button');
    buyBtn.className = 'btn';
    buyBtn.textContent = 'Acquire';
    const isDisabled = coins < u.cost || u.level >= u.maxLevel;
    buyBtn.disabled = isDisabled;
    buyBtn.onclick = () => {
      if (coins >= u.cost && u.level < u.maxLevel) {
        coins -= u.cost;
        u.level++;
        u.cost = Math.round(u.cost * 1.5);
        u.effect();
        addLog(`üõí Power Acquired: ${u.name} (Lvl ${u.level})`);
        showToast(`Power Up: ${u.name}!`);
        updateStats();
        checkAchievements();
        saveGame();
      }
    };
    item.appendChild(buyBtn);
    shopItems.appendChild(item);
  });
}
function renderAchievements() {
  const list = document.getElementById('achievementList');
  list.innerHTML = '';
  achievements.forEach(a => {
    const li = document.createElement('li');
    li.className = a.unlocked ? 'unlocked' : '';
    li.innerHTML = `${a.unlocked ? '‚úÖ' : 'üîí'} ${a.name} - ${a.desc}`;
    list.appendChild(li);
  });
}
function updateBackground() {
  let bgIndex = 0;
  if (level >= 25) bgIndex = 4;
  else if (level >= 20) bgIndex = 3;
  else if (level >= 15) bgIndex = 2;
  else if (level >= 10) bgIndex = 1;
  else if (level >= 5) bgIndex = 0; // BALTI.JPG is default, but per request, at 5 it's BALTI1? Wait, request: at 5: BALTI.JPG? No:
  // Request: at Lvl. 5: BALTI.JPG, 10: BALTI1.JPG, 15:2,20:3,25:4
  // But default is BALTI.JPG, so at 5 change to BALTI.JPG? That doesn't make sense, probably typo.
  // Original: "jeweils zu: BALTI.JPG; BALTI1.JPG; BALTI2.JPG; BALTI3.JPG; BALTI4.JPG"
  // For levels 5,10,15,20,25
  // So level 5: BALTI.JPG, but default is already BALTI.JPG, perhaps start with something else? No, probably level 1-4: BALTI.JPG, 5: BALTI1, but request says BALTI for 5.
  // Wait, "Lvl. 5; 10; 15; 20 und lvl 25 soll das Hintergrund ge√§ndert werden jeweils zu: BALTI.JPG; BALTI1.JPG; BALTI2.JPG; BALTI3.JPG; BALTI4.JPG"
  // So level 5: BALTI.JPG, 10: BALTI1, etc.
  // But default is BALTI.JPG, so at level 5 it changes to BALTI.JPG (same), at 10 to BALTI1, etc.
  // Perhaps it's a list starting from 5 = BALTI, but to make sense, maybe shift.
  // I'll implement as is: level milestones [5,10,15,20,25] to backgrounds [0,1,2,3,4]
  // But for level <5, use BALTI.JPG as default.
  // For level >=5 and <10 use BALTI.JPG, >=10<15 BALTI1, etc.
  let bgFile;
  if (level >= 25) bgFile = 'BALTI4.JPG';
  else if (level >= 20) bgFile = 'BALTI3.JPG';
  else if (level >= 15) bgFile = 'BALTI2.JPG';
  else if (level >= 10) bgFile = 'BALTI1.JPG';
  else if (level >= 5) bgFile = 'BALTI.JPG';
  else bgFile = 'BALTI.JPG'; // Default
  document.body.style.background = `url('${bgFile}') center/cover no-repeat, radial-gradient(circle at 20% 10%, #16201a 0%, #080808 60%)`;
}

// -------------------
// Canvas Draw
// -------------------
function draw() {
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  const cell = w / GRID_SIZE;
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const x = c * cell, y = r * cell;
      ctx.fillStyle = 'rgba(10,10,10,0.6)';
      roundRect(ctx, x + 6, y + 6, cell - 12, cell - 12, 8);
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,255,127,0.06)';
      ctx.lineWidth = 1;
      roundRect(ctx, x + 6, y + 6, cell - 12, cell - 12, 8);
      ctx.stroke();
      const plant = farm[r][c];
      if (plant) drawPlant(ctx, plant, x + cell / 2, y + cell / 2 + 8, cell * 0.38);
    }
  }
}
function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
}
function drawPlant(ctx, plant, cx, cy, size) {
  const progress = plant.growth / 100;
  const t = performance.now() / 1000;
  const sway = Math.sin(t + plant.sway) * 3 * (1 - progress);
  ctx.save();
  ctx.translate(cx, cy + size * 0.25);
  ctx.rotate(sway * 0.02);
  ctx.strokeStyle = '#2c6a3a';
  ctx.lineWidth = Math.max(1, 2 * progress);
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.quadraticCurveTo(0 - size * 0.05, -size * 0.25 - progress * size * 0.75, 0, -size * 1.0);
  ctx.stroke();
  const leafCount = 4 + Math.floor(progress * 4);
  for (let i = 0; i < leafCount; i++) {
    const angle = (i / leafCount) * Math.PI * 2 + (1 - progress) * 0.8;
    drawLeaf(ctx, Math.cos(angle) * size * 0.35, -size * 0.8 + Math.sin(angle) * size * 0.06, size * 0.48 * progress, plant.strain.color, progress, i);
  }
  if (progress > 0.85) {
    const budSize = 6 + (progress - 0.85) * 40;
    const grad = ctx.createRadialGradient(0, -size * 1.0, budSize * 0.2, 0, -size * 1.0, budSize);
    grad.addColorStop(0, 'gold');
    grad.addColorStop(1, plant.strain.color);
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(0, -size * 1.0, budSize, 0, Math.PI * 2);
    ctx.fill();
  }
  plant.particles.forEach(p => p.draw(ctx));
  ctx.restore();
}
function drawLeaf(ctx, lx, ly, sz, color, progress, idx) {
  ctx.save();
  ctx.translate(lx, ly);
  ctx.rotate(Math.sin(idx + performance.now() / 800) * 0.14 * (1 - progress));
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.bezierCurveTo(sz * 0.4, -sz * 0.2, sz * 0.8, -sz * 0.6, sz, -sz * 0.9);
  ctx.bezierCurveTo(sz * 0.6, -sz * 0.6, sz * 0.2, -sz * 0.2, 0, 0);
  const g = ctx.createLinearGradient(0, -sz, 0, sz * 0.6);
  g.addColorStop(0, color);
  g.addColorStop(1, shadeColor(color, -20));
  ctx.fillStyle = g;
  ctx.fill();
  ctx.globalAlpha = 0.14;
  ctx.beginPath();
  ctx.ellipse(sz * 0.2, -sz * 0.35, sz * 0.25, sz * 0.12, -0.6, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.restore();
}

// Confetti Setup
const confettiCanvas = document.getElementById('confettiCanvas');
const confettiCtx = confettiCanvas.getContext('2d');
confettiCanvas.width = window.innerWidth;
confettiCanvas.height = window.innerHeight;
let confettis = [];
let confettiAnimation;
function rainConfetti(duration = 3000) {
  confettis = Array.from({length: 200}, () => new Confetti());
  const startTime = performance.now();
  function animateConfetti(now) {
    if (now - startTime > duration) {
      confettis = [];
      cancelAnimationFrame(confettiAnimation);
      return;
    }
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    confettis.forEach(c => {
      c.update();
      c.draw(confettiCtx);
    });
    confettiAnimation = requestAnimationFrame(animateConfetti);
  }
  animateConfetti(performance.now());
}
window.addEventListener('resize', () => {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
});

// -------------------
// Game Loop
// -------------------
let last = performance.now();
function frame(now) {
  const dt = Math.min(60, now - last);
  last = now;
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const p = farm[r][c];
      if (p) p.grow(dt);
    }
  }
  if (autoPlantUnlocked && now - lastAutoPlant > 5000) {
    plantRandom(true);
    lastAutoPlant = now;
  }
  draw();
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

// -------------------
// Gameplay functions
// -------------------
function getUnlockedStrains() {
  return strains.filter(s => s.unlocked);
}
function plantRandom(silent = false) {
  let planted = false;
  const availableStrains = getUnlockedStrains();
  if (availableStrains.length === 0) return false;
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      if (!farm[r][c] && Math.random() < 0.28) {
        const s = availableStrains[Math.floor(Math.random() * availableStrains.length)];
        farm[r][c] = new Plant(s);
        if (!silent) addLog(`üå± Deployed: ${s.name}`);
        planted = true;
      }
    }
  }
  if (planted && !silent) {
    playSound('plantSound');
    showToast('Seeds Unleashed');
  }
  return planted;
}
function fillAllEmpty() {
  let any = false;
  const availableStrains = getUnlockedStrains();
  if (availableStrains.length === 0) return;
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      if (!farm[r][c]) {
        const s = availableStrains[Math.floor(Math.random() * availableStrains.length)];
        farm[r][c] = new Plant(s);
        any = true;
      }
    }
  }
  if (any) {
    playSound('plantSound');
    addLog('üîÅ Conquered All Empty Plots');
    showToast('Grid Dominated');
  }
}
function harvestReady() {
  let any = false;
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const p = farm[r][c];
      if (p && p.isReady()) {
        const gainedXP = Math.round(p.strain.xp * xpMultiplier);
        const gainedCoins = Math.round(p.strain.coins * coinMultiplier);
        xp += gainedXP;
        coins += gainedCoins;
        harvested++;
        addLog(`üåæ Conquered: ${p.strain.name} (+${gainedXP} XP, +${gainedCoins} Coins)`);
        farm[r][c] = null;
        any = true;
      }
    }
  }
  if (any) {
    playSound('harvestSound');
    checkLevelUp();
    checkAchievements();
    updateStats();
    showToast('Harvest Triumph!');
    saveGame();
  } else {
    showToast('No Beasts Ready', 1000);
  }
}
function checkLevelUp() {
  let threshold = xpThresholdForLevel(level);
  let leveledUp = false;
  while (xp >= threshold) {
    xp -= threshold;
    level++;
    leveledUp = true;
    unlockStrains();
    addLog(`üî• ASCENSION! Level ${level} Achieved`);
    showToast(`ASCENSION! Level ${level}`);
    playSound('levelUpSound');
    threshold = xpThresholdForLevel(level);
  }
  if (leveledUp) {
    updateBackground();
    checkAchievements();
  }
}
function resetGame() {
  if (confirm('Are you sure? This will wipe out your empire and start fresh!')) {
    localStorage.removeItem('miniFarmingSave');
    location.reload();
  }
}

// -------------------
// Input
// -------------------
canvas.addEventListener('click', (ev) => {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const cssX = (ev.clientX - rect.left) * scaleX;
  const cssY = (ev.clientY - rect.top) * scaleY;
  const cell = canvas.width / GRID_SIZE;
  const col = Math.floor(cssX / cell);
  const row = Math.floor(cssY / cell);
  if (row >= 0 && row < GRID_SIZE && col >= 0 && col < GRID_SIZE) {
    if (!farm[row][col]) {
      const availableStrains = getUnlockedStrains();
      if (availableStrains.length === 0) return showToast('No Strains Available');
      const s = availableStrains[Math.floor(Math.random() * availableStrains.length)];
      farm[row][col] = new Plant(s);
      addLog(`üå± Deployed: ${s.name} (Manual)`);
      playSound('plantSound');
      showToast('Seed Deployed');
    } else {
      if (farm[row][col].isReady()) {
        const p = farm[row][col];
        const gainedXP = Math.round(p.strain.xp * xpMultiplier);
        const gainedCoins = Math.round(p.strain.coins * coinMultiplier);
        xp += gainedXP;
        coins += gainedCoins;
        harvested++;
        addLog(`üåæ Conquered: ${p.strain.name} (+${gainedXP} XP, +${gainedCoins} Coins)`);
        farm[row][col] = null;
        playSound('harvestSound');
        checkLevelUp();
        checkAchievements();
        updateStats();
        showToast('Conquered');
        saveGame();
      } else {
        showToast('Beast Not Ready');
      }
    }
  }
});
document.getElementById('plantBtn').addEventListener('click', () => {
  if (plantRandom()) updateStats();
  else showToast('No Space to Deploy');
  saveGame();
});
document.getElementById('harvestBtn').addEventListener('click', () => { harvestReady(); });
document.getElementById('fillBtn').addEventListener('click', () => { fillAllEmpty(); updateStats(); saveGame(); });
document.getElementById('newStartBtn').addEventListener('click', resetGame);

// Init
loadGame();
plantRandom();
setInterval(saveGame, 30000); // Auto-Save
</script>
</body>
</html>
